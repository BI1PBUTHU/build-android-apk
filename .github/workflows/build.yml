name: android_build

on:
  workflow_dispatch:
    inputs:
      project_url:
        description: 'Enter the URL of the GitHub repository containing the Android project'
        required: true
        default: 'https://github.com/BI1PBUTHU/MobileIMSDK'
        type: string

      project_subdir:
        description: 'Enter the subdirectory path of the Android project within the repository (relative to root)'
        required: true
        default: 'demo_src/TCP_Client/MobileIMSDK4aDemo_tcp'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: 检出当前仓库代码
      - name: Checkout the code
        uses: actions/checkout@v3

      # Step 2: 设置 JDK 环境
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 8

      # Step 3: 克隆用户提供的项目仓库
      - name: Clone project repository
        run: |
          echo "Cloning repository: ${{ github.event.inputs.project_url }}"
          git clone --depth=1 ${{ github.event.inputs.project_url }} project

      # Step 4: 进入子目录并构建 APK
      - name: Build the app
        working-directory: ./project/${{ github.event.inputs.project_subdir }}
        run: |
          if [ ! -f "gradlew" ]; then gradle wrapper; fi
          chmod +x gradlew
          ./gradlew assembleDebug --stacktrace

      # Step 5: 上传生成的 APK
      - name: Upload APK
        uses: actions/upload-artifact@v3
        with:
          name: my-build-apk
          path: ./project/${{ github.event.inputs.project_subdir }}/app/build/outputs/apk/debug/*.apk
